# Nyanko Judger
## About

*This project is a part of Nyanko OJ.*

A free, open-source, extensible, seccomp-based judger system.

Nyanko judger consists of:

- *Njudger*: The core of Nyanko Judger that executes certain judgements.
- *Njudgerd*: Provides management for judgements.
- *Nchecker*: The default checker of Nyanko Judger.

## Build

```
	$ cd build
	$ make
```

## Run a Judgement Using Njudger

Use the following command to run a judgement.
    
```
	$ njudger [OPTIONS] <SRCFILE> <DATADIR> <LOGGERILE>
```

*Njudger* will execute *SRCFILE* (Nyanko Judger will compile it first if necessary) for each file with the extension *'.in'* in the directory *DATADIR* to which judger will redirect the standard input. 

After that, Nyanko Judger will use a checker to judge user's program. The path of the source file, the input file, user's output file, and external files will be converyed as arguments to the checker. External files (usually they are the output of the correct answer) will not be used for user's program. The external files for each input must have the filename same as the input file, and with the extensions of *.ext1, .ext2*, ... 

The result of the judgement will be saved to *LOGGERFILE*. See *Judgement Result* section for more details about *LOGGERFILE*.

## Judgement Result
The *LOGGERFILE* generated by *Njudger* will be a JSON file with the format below.

```
{
	"description": "Njudger Logger File",
	"version": "0.0.1",
	"srcFile": "<SRCFILE>"
	"dataDir": "<DATADIR>",
	"test":
	[
		{
			"input": "1.in",
			"cpuTime" : 100,
			"realTime" : 109,
			"memoryUsage" : 16797,
			"result": "Accepted",
			"resultCode": 0,
			"judgerLog": "Accepted"
		},
		{
			"input": "2.in",
			"cpuTime": 127,
			"realTime": 154,
			"memoryUsage": 20419,
			"result": "Wrong Answer",
			"resultCode": 1,
			"judgerLog": "Wrong Answer. User's output differs with the answer."
		}
	],
	"result": "Wrong Answer",
	"resultCode": 1,
	"maxCpuTime": 200,
	"maxRealTime": 251,
	"maxMemoryUsage": 20419,
	"judgerLog" : "Wrong answer on test 2 (2.in)",
	"compileLog" : "This will only be set when compilation error."
	"exitCode": 0,
	"errorMessgae" : "SUCCESS",
	"etc": "Nyan~"
}
```

Explanations:

- **description**: Just as what it means.
- **version**: The version of Nyanko Judger.
- **srcfile, dataDir**: They are simply copied from the arguments when you run Nyanko Judger.
- **test**: An array contains the information for each test.
- **input**: The input file for each test.
- **result, resultcode**: The result of the judgement/test. See *Result Code* section for more details.
- **cpuTime, realTime, memoyUsage**: The resource cost for each test, in milliseconds/kilobytes.
- **maxCpuTime, maxRealTime, maxMemoryUsage**: These properties are simply generated by calcualting the maximum value among the resource cost for each test.
- **compilerLog**: This will only be set when an the judgement result is *Compilation Error*. The information for the error will be stored in this property.
- **exitCode, errorMessage**: *exitcode* is the exit code returned from Nyanko Judger. Generally it should be zero, otherwise this means an error occured. The *errorMessage* will contain the description of the error.
- **etc**: Nyanko Judger will *Nyan~* after finishing a judgement.

## Result Code
The result code will be one of the following:

- **0: Accepted**
- **1: Wrong Answer**
- **2: Presentation Error**
- **3: Time Limit Excceeded**
- **4: Memory Limit Excceeded**
- **5: Output Limit Excceeded**
- **6: Code Length Limit Excceeded**
- **7: Runtime Error**
- **8: Compilation Error**
- **9: Checker Error**
- **10: System Error**

The result code of 0~2 will be only obtained from the checker. For details about checker, see *Checker Guide*.

## Checker Guide

Nyanko Judger provides a default checker, but you may need to write a checker if you need special judge. *Njudger* will run a checker with the following format:

```
    $ checker <src-file> <input-file> <user-output-file> <external-file-1> <external-file-2> <...>
```

where src-file, input-file, uesr-output-file,  external-file-1, external-file-2, ... indicate the source file of user's program, the input file, the output file of user's program, and external files for each input, respectively.

For instance, *Nchecker* will check whether program-output-file is exactly the same as one of the external files.

*Njudger* will use the exit code of checker as the judgement result. The checker should exit with an exit code of 0~2, otherwise judger will return a result of "Checker Error".

The standard output of checker will be regarded as the checker log, and will be added into the corresponding fields in *LOGGERFILE*.

## Njudgerd

*Njudgerd* provides strong management for judgements, which allows you to run and manage the judgements easily in various environments, such as online judge system.

Run the following command to run *Njudgerd* as daemon.

```
	$ njudgerd -d
```

*Njudgerd* uses UDP as communication protocol. You can simply create two UDP sockets, one sending requests to *Njudgerd* and the other one receiving responses.

To send a judgement request, use the following format:

```
	{
	"type": "judgement-request",
	"judgement":
	{
		"srcFile": "/tmp/1.cpp",
		"dataDir": "/opt/nyanko-oj/data/problems/1000",
		"language": 0,
		"timeLimit": 1000,
		"memoryLimit": 131072,
		"codeLengthLimit": 65535,
		"checker": "default"
	},
	"information":
	{
		"submissionID": 19260817
	}
	}
```

The realtime judgement status, the final judgement result, and the error log will be sent to the listener (for details about how to set the listener, refer to *Njudgerd Configuration* section), with the following format:

```
{
	"type": "judgement-status",
	"status": "Running on test 3 (3/7): 3.in",
	"timestamp": "Thu Jun 25 23:17:55 2020",
	"information":
	{
		"submissionID": 19260817
	}
}

```

```
{
	"type": "judgement-result",
	"judgerLogger":
	{
		{
			"description": "Njudger Logger File",
			"version": "0.0.1",
			"srcFile": "<SRCFILE>"
			"dataDir": "<DATADIR>",
			"test":
			[
				{
					"input": "1.in",
					"cpuTime" : 100,
					"RealTime" : 109,
					"memoryUsage" : 16797,
					"result": "Accepted",
					"resultCode": 0,
					"judgerLog": "Accepted"
				},
				{
					"input": "2.in",
					"cpuTime": 127,
					"RealTime": 154,
					"memoryUsage": 20419,
					"result": "Wrong Answer",
					"resultCode": 1,
					"judgerLog": "Wrong Answer. User's output differs with the answer."
				}
			],
			"result": "Wrong Answer",
			"resultCode": 1,
			"maxCpuTime": 200,
			"maxRealTime": 251,
			"maxMemoryUsage": 20419,
			"judgerLog" : "Wrong answer on test 2 (2.in)",
			"compileLog" : "This will only be set when compilation error."
			"exitCode": 0,
			"errorMessgae" : "SUCCESS",
			"etc": "Nyan~"
		}
	},
	"exitCode": 0,
	"errorMessage": "SUCCESS",
	"timestamp": "Thu Jun 25 23:17:56 2020",
	"information":
	{
		"submissionID": 19260817
	}
}
```

```
{
	"type": "judgement-error-log',
	"exitCode": 4,
	"errorLog": "Invalid configuration file...",
	"information":
	{
		"submissionID": 19260817
	}
}
```

Explanations:

- **type**: Specify the type of the contents. It may be one of:
    - *judgement-request*: Plase set this property to *judgement-request* when you want to send a judgement request.
    - *judgement-result*, *judgement-status*, *judgement-error-log*: These values will be set by njudgerd when sending information about judgement to the listener.
    - *general-response*: This value will be set by njudgerd for other type of responses (for instance, when there is an error occured).
- **status**: The realtime status of the judgement.
- **judgerLogger**: Njudgerd simply copied the content of *LOGGERFILE* generated by njudger to *judgerLogger*.
- **exitCode, errorMessage**: The exit code of Njudger and the corresponding error message.
- **timestamp**: The timestamp of the corresponding record.
- **information**: You may store the information of your judgement in this property to identify each judgement. Njudgerd will always attach this property to the listener without any change.

## Configurations

### Njudger Configurations

Njudger will scan configuration file in the following order, and load the first one found:

```./njudger.conf ~/.njudger.conf /etc/njudger.conf```

or, if you specify a `--conf` option, Njudger will load configuration file from the specified file instead.

The configuration file should have the following format:

```
{
	"description": "Njudger Configuration File",
	"version": "0.0.1",
	"lang":
	[
		{
			"id": 0,
			"name": "C++",
			"needCompile": true,
			"compileCommand": "g++ --std=c++14 -O2 -D ONLINE_JUDGE -o %DESTFILE% %SRCFILE%",
			"runCommand": "%DESTFILE%",
			"maxCompileTime": 20000,
			"maxCompileMemory": 1000000,
			"maxCompileOutput": 2097152
		},
		{
			"id": 4,
			"name": "Python 3",
			"needCompile": false,
			"runCommand": "python3 %SRCFILE%"
		}
	],
	"checker":
	{
		"default": "./nchecker",
		"maxRunningTime": 20000,
		"maxRunningMemory": 2097152,
		"maxRunningOutput": 512
	},
	"maxOutput": 2097152,
	"strategy": "default",
	"defaultChecker": "./nchecker"
}
```

Explanations:

- **description**: Just as what it means.
- **lang**: An array specifies all supported languages. 
- **ID**: The ID of the language. All ID must be distinct, otherwise Njudger will exit with an error.
- **name**: The name of the language.
- **needCompile**: Specify whether user's program need to be compiled first. If this is specified as true, then *compileCommand* must be specified as well; otherwise *runCommand* must be specified.
- **compileCommand, runCommand**: Specify the compile command or running command for the corresponding language. Use *%SRCFILE%* to indicate the source file of user's program, and *%DESTFILE%* to indicate the destination file after compiling (this will be automatically generated by njudger).
- **maxCompileTime, maxCompileMemory, maxCompileOutput**: Specify the limit of the resource usage in compiling, in milliseconds/killobytes/bytes.
- **checker.default**: Specify the default checker to run.
- **checker.maxRunningTime, checker.maxRunningMemory, checker.maxRunningOutput**: Specify the resource limit when running the checker.
- **maxOutput**: Specify the maximum output of user's program, in bytes.
- **strategy**: Speicfy the strategy of judgement. It must be one of:
    - *default*: Njudger will stop the judgement immidietly and returns the result if user's program didn't pass one of the test, or an error occured in the checker.
    - *force*: Njudger will always judge user's program on all tests, no matter user's program failed on one of them or not.

### Njudgerd Configurations

Njudger will scan configuration file in the following order, and load the first one found:

```./njudgerd.conf ~/.njudgerd.conf /etc/njudgerd.conf```

or, if you specify a `--conf` option, Njudger will load configuration file from the specified file instead.

The configuration file should have the following format:

```
{
	"description": "Njudgerd Configuration File",
	"version": "0.0.1",
	"server":
	{
		"port": 7998
	},
	"listener":
	{
		"host": "localhost",
		"port": 3999
	},
	"jobs":
	{
		"maxCount": 2000,
		"maxThreads": 10
	},
	"njudger": 
	{
		"location": "./njudger"
	}
}
```

Explanations:

- **description**: Just as what it means.
- **version**: The version of *Njudgerd*.
- **server.port**: Specify the port *Njudgerd* will listen to.
- **listener.host, listener.port**: Specify the host and port of the listener. *Njudgerd* will send the status, result and error message of judgement to the corresponding address.
- **jobs.maxCount**: Specify the maximum number of jobs in queue. Njudgerd won't handle judgement requests when the queue is full.
- **jobs.maxThreads**: Specify the maximum judgement threads in one time.
- **njudger.location**: Specify the location of *njudger*. If not specified, *Njudgerd* will search *njudger* using the environment variables *PATH* first, and if not found, search it in the working directory instead.
